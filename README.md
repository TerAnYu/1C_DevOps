# 1C-DevOps

## Описание

В данном репозитории находятся файлы настроек для создания Docker образов и развертывания Docker контейнеров приложений, относящихся к разработке на платформах **1С:Предприятие** и **1С:Элемент**.

Репозиторий содержит:

- Файлы *Dockerfile* для создания образов.
- Файлы *.arg.tmpl* - шаблоны для задания аргументов сборки образов.
   > Для кастомизации образов файлы аргументов сборки *.arg* помещены в *gitignore*, чтобы они не влияли на репозиторий.
- Файлы *docker-compose.yml* для создания контейнеров с помощью `docker compose`.
- Файлы *docker-stack.yml* для создания контейнеров с помощью `docker stack deploy`.
- Файлы *.env.tmpl* - шаблоны для задания переменных среды.
   > Для кастомизации контейнеров файлы переменных среды *.env* помещены в *gitignore*, чтобы они не влияли на репозиторий.
- Файлы */swarm/*.tmpl* - шаблоны конфигураций для **Docker Swarm**.
   > Файлы шаблонов содержат минимальные настройки для успешного запуска приложения для предварительного знакомства.
- Файлы *\*.sh* - вспомогательные скрипты для настройки инфраструктуры.

## Порядок работы с репозиторием

1. **Создать образ**.
   - Для инициализации скрипта создания образа необходимо инициализировать каталог с настройками образа с помощью скрипта `docker/init.sh`.
     - Задайте имя проекта образа.
     - Выберите приложение для образа.
     - После этого создастся скрипт сборки и скрипт переменных в папке `user_builds`, которая добавлена в *gitignore*.
     - Поместите установочные файлы в `docker/common_context/build/distr`, они должны называться, например: *1cesb_7.1.4+12_all.deb* и *1cesbide_7.1.4+12_all.deb*.

2. **Развернуть контейнер с минимальными настройками** (docker compose, docker stack deploy).
   - **Docker Compose**:
     - Запуск осуществляется с помощью файла скрипта *compose.sh*.
   - **Docker Swarm**:
     - Запуск осуществляется с помощью файла скрипта *deploy.sh*.
   - **Portainer**:
     - Запуск осуществляется через веб-интерфейс платформы для управления контейнерами Portainer.
   > Для запуска приложения необходимо создать файл переменных среды *.env* на основе шаблона *.env.tmpl*.

3. **Настроить приложения в контейнере** с помощью пользовательских настроек (внутри самого приложения или конфигурационных файлов).

## Сборка **1С: Шины (ESB)**

- Необходимо, чтобы в системе были установлены приложения: `debhelper devscripts dialog`.
- Поместите файлы *1c_enterprise_esb_7.1.4+12_linux_x86_64.tar.gz* и *1c_enterprise_esb_with_ide_7.1.4+12_linux_x86_64.tar.gz* в `build_deb/esb`.
- Запустите сборку deb пакетов командой: `build_deb/esb/debuild.sh`.
- По окончании сборки получите файлы, например: *1cesb_7.1.4+12_all.deb* и *1cesbide_7.1.4+12_all.deb*.
- Поместите установочные файлы в `docker/common_context/build/distr`, они должны называться, например: *1cesb_7.1.4+12_all.deb* и *1cesbide_7.1.4+12_all.deb*.
- Внесите изменения в файл аргументов: `docker/users/builds/esb/.arg`, например:

```bash
# 1cesb/build

## OS options
OS_TAG="debian:bookworm-slim"

## ESB options
OC_ESB_VERSION="7.1.4+12"
# > esb, esbide
OC_ESB_TYPE="esbide"
OC_ESB_TAG="1c/${OC_ESB_TYPE}:${OC_ESB_VERSION/+/.}"

## Install options
INSTALL_MODE="${INSTALL_MODE:-install_from_file}"

### install_from_file
INSTALL_FILES="1c${OC_ESB_TYPE}_${OC_ESB_VERSION}_all.deb"

### install_from_repo
APTLY_REPO_COMPONENTS="1c main"
INSTALL_PACKS="1c${OC_ES
