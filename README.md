# 1C-DevOps

## Описание

В данном репозитории находятся файлы настроек для создания docker образов и развертывания docker контейнеров приложений, относящихся к разработке на платформах 1С:Предприятие, 1С:Элемент.

Репозиторий содержит:

- Файлы *dockerfile* для создания репозитория.
- Файлы *.arg.tmpl* - как шаблоны файлов для задания аргументов сборки образов.
   > Для кастомизации образов файлы аргументов сборки образов *.arg* помещены в *gitignore*, чтобы они не влияли на репозиторий.
- Файлы *docker-compose.yml* для создания контейнеров с помощью `docker compose`
- файлы *docker-stack.yml* для создания контейнеров с помощью `docker stack deploy`
- Файлы *.env.tmpl* - как шаблоны файлов для задания переменны среды.
   > Для кастомизации контейнеров файлы переменных среды *.env* помещены в *gitignore*, чтобы они не влияли на репозиторий.
- Файлы */swarm/\*.tmpl* - как шаблоны файлов конфигураций для **docker swarm**.
   > Файлы шаблонов настроек содержат минимальные настройки для успешного запуска приложения для предварительного знакомства.
- Файлы *\*.sh* - вспомогательные скрипты для настройки инфраструктуры.

Порядок работы с репозиторием:

- Создать образ.
  Для инициализации скрипта создания образа необходимо инициализировать каталог с настройками образа с помощью скрипта docker/init.sh
    - Необходимо задать имя проекта образа
    - Необходимо выбрать приложение для образа
    - После чего создастся скрипт сборки и скрипт переменных в папке user_builds, которая добавлена в *gitignore*
    - Поместить установочные файлы в docker/common_context/build/distr, они должны называться, например: *1cesb_7.1.4+12_all.deb* и *1cesbide_7.1.4+12_all.deb*
- Развернуть контейнер с минимальными настройками (docker compose, docker stack deploy).
  - **Docker compose**
    - Запуск осуществляется с помощью файла скрипта *compose.sh*
  - **Docker swarm**
    - Запуск осуществляется с помощью файла скрипта *deploy.sh*
  - **Portainer**
    - Запуск осуществляется через web-интерфейс платформы для управления контейнерами Portainer.
  > Для запуска приложения необходимо создать файл переменны среды *.env* на основе шаблона *.env.tmpl*.
- Настроить приложения в контейнере помощью пользовательских настроек (внутри самого приложения или конфигов).


Для сборки **1С: Шины (esb)**:
    - Необходимо, что бы в системе были установлены приложения: `debhelper devscripts dialog`
    - Помещаем файлы *1c_enterprise_esb_7.1.4+12_linux_x86_64.tar.gz* и *1c_enterprise_esb_with_ide_7.1.4+12_linux_x86_64.tar.gz* в *build_deb/esb*
    - Запускаем сборку deb пакетов командой: *build_deb/esb/debuild.sh*
    - По окончании сборки получаем файлы, например: *1cesb_7.1.4+12_all.deb* и *1cesbide_7.1.4+12_all.deb*
    - Поместить установочные файлы в docker/common_context/build/distr, они должны называться, например: *1cesb_7.1.4+12_all.deb* и *1cesbide_7.1.4+12_all.deb*
    - Вносим изменения в файл аргументов: *docker/users/builds/esb/.arg*, например:
```
# 1cesb/build

## OS options

OS_TAG="debian:bookworm-slim"

## ESB options

OC_ESB_VERSION="7.1.4+12"
# > esb, esbide
OC_ESB_TYPE="esbide"
OC_ESB_TAG="1c/${OC_ESB_TYPE}:${OC_ESB_VERSION/+/.}"

## Install options

INSTALL_MODE="${INSTALL_MODE:-install_from_file}"

### install_from_file

INSTALL_FILES="1c${OC_ESB_TYPE}_${OC_ESB_VERSION}_all.deb"

### install_from_repo

APTLY_REPO_COMPONENTS="1c main"
INSTALL_PACKS="1c${OC_ESB_TYPE}=${OC_ESB_VERSION}"
```
    - Запускаем сборку образа *docker/users/builds/esb/docker-build.sh*


> **Важно**. Репозиторий на текущем этапе развития не претендует на полноту описания. Его развитие будет идти по мере изучения новых механизмов и оптимизации изученных раннее. За любую помощь в дополнении или развития текущих файлов настроек автор репозитория будет очень благодарен.

## Содержание

- Инфраструктура
  - [Portainer](docker/portainer/README.md)
  - [Nginx](docker/nginx/README.md)
- Разработка
  - [Gitlab](docker/gitlab/README.md)
  - [Sonarqube](docker/sonarqube/README.md)
- Моделирование
  - [Diagrams](docker/diagrams/README.md)

(Описание дополняется...)
